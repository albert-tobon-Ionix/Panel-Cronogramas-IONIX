<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cronograma Ionix — Gantt (colores desde la tabla)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Paleta parametrizable */
      --bar-1:#005B96; --bar-2:#3A8EC4; --bar-3:#6E7C8E; --bar-4:#2C3E50; --bar-5:#059669; --bar-6:#7c3aed; --bar-7:#f97316;
      --green:#10b981; --grid-border:#d1e4eb; --row-border:#e0e0e0; --panel:#fafafa; --ink:#1f364d;
    }
    *{box-sizing:border-box}
    body{font-family:'Montserrat','Segoe UI',system-ui,-apple-system,Arial; background:#f5f7fb; color:var(--ink); margin:0}
    .wrap{max-width:1100px;margin:24px auto;background:#fff;border:1px solid #e4e7ec;border-radius:16px;padding:16px 20px 28px;box-shadow:0 10px 30px rgba(18,38,63,.06)}
    h1{font-size:28px;font-weight:800;color:var(--bar-1);margin:0 0 12px}
    h2{font-size:18px;margin:0 0 12px}

    .panel{background:var(--panel);border:1px solid #e6e8ee;border-radius:12px;padding:14px;margin-bottom:16px}
    .row{display:grid;gap:10px}.row.cols-2{grid-template-columns:1fr 1fr}
    .label{font-size:12px;color:#52667a;font-weight:600;margin-bottom:6px}
    .input{width:100%;padding:10px 12px;border:1px solid #d7dbe3;border-radius:10px;font-weight:600}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:var(--bar-1);color:#fff;border:0;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(0,91,150,.25)}
    .remove{background:transparent;border:0;color:#e11d48;font-size:22px;cursor:pointer}
    .task-name-chip{width:100%;border:0;border-radius:8px;padding:8px 10px;color:#fff;font-weight:700;text-shadow:0 1px 1px rgba(0,0,0,.4)}
    .task-hrs{width:100%;text-align:center;padding:8px 10px;border:1px solid #d7dbe3;border-radius:8px}

    table{width:100%;border-collapse:collapse}
    thead th{font-size:12px;color:#5b6b7c;background:#eef4f8;text-align:left;padding:8px 10px;border-bottom:2px solid var(--bar-1)}
    tbody td{padding:8px 10px;border-bottom:1px solid #edf1f5}

    /* ======= Gantt ======= */
    #gantt-chart{display:grid;grid-template-columns:250px repeat(1,1fr);border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;position:relative}
    #taskHeader,#timelineContainer{background:#e6f0f4;font-weight:800;padding:8px 16px;border-bottom:2px solid var(--bar-1);color:var(--ink);height:50px;display:flex;align-items:center;justify-content:center}
    #taskHeader{grid-column:1;border-right:1px solid #d1e4eb}
    #timelineContainer{grid-column:2 / -1;padding:0}
    #timelineLabels{display:grid;grid-template-columns:repeat(1,1fr);width:100%;height:100%}
    .timeline-label{display:flex;align-items:center;justify-content:center;font-size:14px;border-right:1px solid var(--grid-border)}
    .timeline-label:last-child{border-right:0}

    .task-cell{grid-column:1;padding:8px 16px;background:#f8f8f8;border-right:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;height:40px}
    .bar-row{position:relative;height:40px;border-bottom:1px solid #e0e0e0}
    .grid-overlay{position:absolute;inset:0;display:grid;z-index:5}
    .bar-cell-divider{height:40px;border-right:1px solid var(--grid-border)}

    .task-bar-segment{position:absolute;top:15%;height:70%;border-radius:6px;display:flex;align-items:center;justify-content:center;padding:0 6px;color:#fff;font-size:11px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.18);white-space:nowrap;z-index:40;pointer-events:none;cursor:default}
    .bg-bar-1{background:var(--bar-1)}.bg-bar-2{background:var(--bar-2)}.bg-bar-3{background:var(--bar-3)}.bg-bar-4{background:var(--bar-4)}.bg-bar-5{background:var(--bar-5)}.bg-bar-6{background:var(--bar-6)}.bg-bar-7{background:var(--bar-7)}

    #goLiveLineContainer{position:absolute;top:50px;bottom:0;left:250px;width:calc(100% - 250px);pointer-events:none;z-index:30}
    #goLiveLineContainer>div{pointer-events:auto}
    .go-live-line{position:absolute;top:0;bottom:0;width:3px;background:var(--green);border-radius:999px;transform:translateX(-50%);cursor:grab;z-index:50}
    .go-live-label{position:absolute;top:-2px;left:50%;transform:translate(-50%,-100%);background:var(--green);color:#fff;font-size:10px;font-weight:800;padding:2px 6px;border-radius:4px;white-space:nowrap}

    .meta{display:flex;flex-wrap:wrap;gap:10px;font-size:12px;color:#41586c}
    .badge{background:#eef4f8;border:1px solid #d7e6ef;border-radius:999px;padding:6px 10px;font-weight:700}

    @media(max-width:768px){.wrap{margin:12px;padding:12px}h1{font-size:22px;text-align:center}.row.cols-2{grid-template-columns:1fr}.panel{padding:10px}.timeline-label{font-size:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel de Control y Cronograma</h1>
    <div class="panel">
      <h2>Edición de Tareas (Duración en Horas)</h2>
      <div class="row cols-2" style="margin-bottom:10px">
        <div><div class="label">Título principal</div><input id="title" class="input" value="Cronograma del Proyecto" /></div>
        <div><div class="label">Subtítulo</div><input id="subtitle" class="input" value="Flujo de Desarrollo y Recorrido de Horas" /></div>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="panel">
      <h2>Detalle de Tareas</h2>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Tarea</th><th style="width:120px;text-align:center">Duración (hh)</th><th style="width:70px">Acción</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <button class="btn" id="addBtn">+ Agregar Tarea</button>
    </div>

    <div class="panel" style="padding:0">
      <div style="padding:16px 16px 0"><h2 id="header"></h2><div class="muted" id="subtitleView"></div></div>
      <div style="padding:16px; overflow-x:auto">
        <div id="gantt-chart">
          <div id="taskHeader">Tarea</div>
          <div id="timelineContainer"><div id="timelineLabels"></div></div>
          <div id="gantt-body" style="display:contents"></div>
          <div id="goLiveLineContainer"><div id="goLiveLine" class="go-live-line"><span class="go-live-label">GO LIVE</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONSTANTES ======
    const HOURS_PER_DAY=8, DAYS_PER_WEEK=5, HOURS_PER_WEEK=HOURS_PER_DAY*DAYS_PER_WEEK;
    const TASK_COLORS=["bg-bar-1","bg-bar-2","bg-bar-3","bg-bar-4","bg-bar-5","bg-bar-6","bg-bar-7"];

    // ====== ESTADO ======
    let tasks=[
      {id:1,name:"Análisis y Diseño",duration:4.9,color:"bg-bar-1"},
      {id:2,name:"Desarrollo",duration:17.0,color:"bg-bar-2"},
      {id:3,name:"Pruebas QA",duration:5.0,color:"bg-bar-3"},
      {id:4,name:"PDR, Documentación y Entrega",duration:2.0,color:"bg-bar-4"}
    ];
    let goLivePercent=100, isDragging=false;

    // ====== HELPERS ======
    const $=s=>document.querySelector(s); const rndId=()=>Math.random().toString(36).slice(2);
    const calcTotalHours=arr=>arr.reduce((s,t)=>s+(parseFloat(t.duration)||0),0);
    function getTimelineUnit(totalHours){const d=totalHours/HOURS_PER_DAY; let unit,hpu,units; if(d<=DAYS_PER_WEEK){unit='day';hpu=HOURS_PER_DAY;units=Math.max(1,Math.ceil(d));} else{unit='week';hpu=HOURS_PER_WEEK;units=Math.ceil(d/DAYS_PER_WEEK);} return {unit,hoursPerUnit:hpu,totalUnits:units,totalGridHours:units*hpu};}
    const fmtH=h=>h%1===0? h.toFixed(0):h.toFixed(1);
    // Helpers CSS vars
    const getVar=(n)=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
    const setVar=(n,v)=>document.documentElement.style.setProperty(n,v);

    // ====== TABLA ======
    function renderTasksTable(){
      const tbody=$('#tbody'); tbody.innerHTML='';
      tasks.forEach((t,i)=>{
        const tr=document.createElement('tr');
        const tdN=document.createElement('td'); const tdH=document.createElement('td'); const tdA=document.createElement('td');

        const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='10px';
        const cssVar = `--bar-${(i%7)+1}`;
        const colorInput=document.createElement('input');
        colorInput.type='color';
        const init = getVar(cssVar) || '#005B96';
        colorInput.value=init.trim().startsWith('#')? init.trim(): '#005B96';
        colorInput.style.width='38px'; colorInput.style.height='28px'; colorInput.style.border='0'; colorInput.style.borderRadius='6px'; colorInput.style.cursor='pointer';

        const nameInput=document.createElement('input');
        nameInput.value=t.name; nameInput.className='task-name-chip'; nameInput.style.background=colorInput.value; nameInput.oninput=e=>{t.name=e.target.value; renderGantt();};

        colorInput.oninput=e=>{ setVar(cssVar, e.target.value); nameInput.style.background=e.target.value; renderGantt(); };

        wrap.appendChild(colorInput); wrap.appendChild(nameInput); tdN.appendChild(wrap);

        const hrs=document.createElement('input'); hrs.type='number'; hrs.step='0.1'; hrs.min='0'; hrs.value=fmtH(t.duration); hrs.className='task-hrs'; hrs.oninput=e=>{t.duration=parseFloat(e.target.value)||0; renderAll();}; tdH.appendChild(hrs);
        const btn=document.createElement('button'); btn.className='remove'; btn.innerHTML='&times;'; btn.onclick=()=>{tasks=tasks.filter(x=>x.id!==t.id); renderAll();}; tdA.appendChild(btn);

        tr.append(tdN,tdH,tdA); tbody.appendChild(tr);
      });
    }

    // ====== GANTT ======
    function renderGantt(){
      const totalHours=calcTotalHours(tasks);
      const {unit,hoursPerUnit,totalUnits,totalGridHours}=getTimelineUnit(totalHours);
      const totalLaboralDays=(totalHours/HOURS_PER_DAY).toFixed(1);
      $('#meta').innerHTML=`<span class="badge">Horas Totales: <b>${totalHours.toFixed(1)} hh</b></span><span class="badge">${totalLaboralDays} ${totalLaboralDays==='1.0'?'día':'días'} laborales</span><span class="badge">Unidad de Tiempo: <b>${unit==='day'?'Días':'Semanas'}</b> (${totalUnits} ${unit==='day'?'días':'semanas'})</span>`;

      const title=$('#title').value; const sub=$('#subtitle').value; $('#header').textContent=`${title} (${totalLaboralDays} ${totalLaboralDays==='1.0'?'día':'días'} / ${totalHours.toFixed(1)} HH)`; $('#subtitleView').textContent=sub;

      const gantt=$('#gantt-chart'); gantt.style.gridTemplateColumns=`250px repeat(${totalUnits},1fr)`;
      const labels=$('#timelineLabels'); labels.style.gridTemplateColumns=`repeat(${totalUnits},1fr)`; labels.innerHTML='';
      for(let i=0;i<totalUnits;i++){const d=document.createElement('div'); d.className='timeline-label'; d.textContent=`${unit==='day'?'Día':'Semana'} ${i+1}`; labels.appendChild(d);} 

      const body=$('#gantt-body'); body.innerHTML='';
      let start=0; const calc=tasks.map(t=>{const dur=parseFloat(Number(t.duration).toFixed(1))||0; const obj={...t,startHour:start,endHour:start+dur}; start+=dur; return obj;});

      calc.forEach((t,i)=>{
        const cell=document.createElement('div'); cell.className='task-cell'; cell.textContent=t.name; body.appendChild(cell);
        const row=document.createElement('div'); row.className='bar-row'; row.style.gridColumn=`2 / ${totalUnits+2}`;
        const seg=document.createElement('div'); seg.className=`task-bar-segment ${t.color}`; const width=(t.duration/totalGridHours)*100; const left=(t.startHour/totalGridHours)*100; seg.style.width=width+'%'; seg.style.left=left+'%'; seg.textContent=`${fmtH(t.duration)} hh`;
        row.appendChild(seg);
        const divs=document.createElement('div'); divs.className='grid-overlay'; divs.style.gridTemplateColumns=`repeat(${totalUnits},1fr)`; for(let j=0;j<totalUnits;j++){const dv=document.createElement('div'); dv.className='bar-cell-divider'; divs.appendChild(dv);} row.appendChild(divs);
        body.appendChild(row);
      });

      // Go Live al final del proyecto si no se arrastra
      const line=$('#goLiveLine'); const projectEndPercent= totalHours>0 ? Math.min(100, Math.max(0,(totalHours/totalGridHours)*100)) : 0; if(!isDragging){ goLivePercent = projectEndPercent; } line.style.left=goLivePercent+'%';
    }

    function renderAll(){renderTasksTable();renderGantt();}

    // ====== EVENTOS ======
    $('#addBtn').onclick=()=>{const idx=tasks.length%TASK_COLORS.length; tasks.push({id:rndId(),name:'Nueva Tarea',duration:8,color:TASK_COLORS[idx]}); renderAll();};
    $('#title').oninput=$('#subtitle').oninput=()=>renderGantt();

    const lineEl=$('#goLiveLine'), container=$('#goLiveLineContainer');
    lineEl.addEventListener('pointerdown',e=>{isDragging=true; lineEl.setPointerCapture(e.pointerId); lineEl.style.cursor='grabbing';});
    document.addEventListener('pointerup',()=>{isDragging=false; lineEl.style.cursor='grab';});
    document.addEventListener('pointermove',e=>{if(!isDragging) return; const rect=container.getBoundingClientRect(); let x=e.clientX-rect.left; x=Math.max(0,Math.min(x,rect.width)); goLivePercent=(x/rect.width)*100; lineEl.style.left=goLivePercent+'%';});
    lineEl.addEventListener('keydown',e=>{let step=1; if(e.key==='ArrowLeft'){goLivePercent=Math.max(0,goLivePercent-step); renderGantt(); e.preventDefault();} if(e.key==='ArrowRight'){goLivePercent=Math.min(100,goLivePercent+step); renderGantt(); e.preventDefault();}}); lineEl.tabIndex=0;

    // ====== INICIO ======
    renderAll();

    // ====== PRUEBAS AUTOMÁTICAS (básicas) ======
    (function runTests(){
      try{
        console.log('%c[TEST] Inicio de pruebas','color: #2563eb');
        // 1. No deben existir los elementos del popover antiguo
        console.assert(!document.querySelector('#ok') && !document.querySelector('#colorPopover'), 'No debe existir popover antiguo (#ok/#colorPopover)');
        // 2. Deben existir tantas entradas de color como tareas
        const colorPickers = () => Array.from(document.querySelectorAll('tbody input[type="color"]'));
        console.assert(colorPickers().length === tasks.length, 'Cantidad de color pickers debe igualar tareas');
        // 3. Cambiar el primer color actualiza la variable CSS y re-renderiza sin errores
        if(colorPickers().length){
          const cssVar = '--bar-1';
          const before = getVar(cssVar);
          colorPickers()[0].value = '#1e90ff';
          colorPickers()[0].dispatchEvent(new Event('input', {bubbles:true}));
          const after = getVar(cssVar);
          console.assert(before !== after, 'La variable CSS debería actualizarse al cambiar el picker');
        }
        // 4. Debe haber tantas barras en el Gantt como tareas
        console.assert(document.querySelectorAll('.task-bar-segment').length === tasks.length, 'El gantt debe renderizar una barra por tarea');
        console.log('%c[TEST] OK','color: #16a34a');
      }catch(e){
        console.error('[TEST] Falló:', e);
      }
    })();
  </script>
</body>
</html>

